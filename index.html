<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- CSP: More permissive in dev mode for Vite HMR and worklets -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:* ws://localhost:*; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:*; style-src 'self' 'unsafe-inline'; img-src 'self' data: file:; connect-src 'self' http://localhost:* ws://localhost:*; worker-src 'self' blob:; media-src 'self' blob: file:; child-src 'self' blob:;" />
    <title>Granular Music Tool</title>
    <link rel="stylesheet" href="./src/styles.css" />
  </head>
  <body>
    <div id="app">
      <div class="window-drag-bar"></div>
      <div class="app-layout">
        <!-- XY Pad - Left side -->
        <main class="xy-pad-container">
          <!-- Floating Header -->
          <div class="xy-floating-header">
            <div class="app-header-section">
              <img id="appLogo" src="./images/logo.png" alt="Logo" class="logo-icon" />
              <div class="app-header-text">
                <h2 class="app-logo">
                  <span class="logo-text">Undergrain</span>
                  <span class="beta-badge">BETA</span>
                </h2>
                <p class="app-subtitle">topographic granulator</p>
                <p class="app-version">v0.1.0</p>
              </div>
            </div>
            <div class="xy-controls-top">
              <div class="control-group">
                <label style="grid-template-columns:auto auto auto 1fr;gap:8px;align-items:center;">
                  <span>Mode</span>
                  <button id="xyModeParams" class="xy-mode-btn active" data-mode="params" title="Single parameters" aria-label="Single parameters">
                    <span class="xy-mode-icon">▬</span>
                  </button>
                  <button id="xyModePads" class="xy-mode-btn" data-mode="pads" title="Pad" aria-label="Pad">
                    <span class="xy-mode-icon">▦</span>
                  </button>
                </label>
              </div>
              <span class="xy-hint">
                <span class="hint-text">Arrow keys</span>
                <span class="hint-arrows">
                  <span class="arrow-key">←</span>
                  <span class="arrow-key">↑</span>
                  <span class="arrow-key">→</span>
                  <span class="arrow-key">↓</span>
                </span>
                <span class="hint-text">to move</span>
              </span>
            </div>
          </div>
          <div class="xy-pad-wrapper">
            <div class="xy-header">
              <div class="xy-assign">
                <div class="xy-pad-canvas-container">
                  <canvas id="xyPad" width="800" height="800"></canvas>
                  <div id="xyCornerTL" class="xy-corner-selector xy-corner-tl" aria-label="Top left corner"></div>
                  <div id="xyCornerTR" class="xy-corner-selector xy-corner-tr" aria-label="Top right corner"></div>
                  <div id="xyCornerBL" class="xy-corner-selector xy-corner-bl" aria-label="Bottom left corner"></div>
                  <div id="xyCornerBR" class="xy-corner-selector xy-corner-br" aria-label="Bottom right corner"></div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <!-- Sidebar - Right side with dense grid, no empty spaces -->
        <aside class="app-sidebar">
          <!-- Waveform - spans full width -->
          <div class="grid-item grid-item-waveform">
            <div class="waveform-wrap">
              <canvas id="waveform" width="1200" height="160"></canvas>
              <div class="waveform-meta">
                <span>Selection: <span id="selStart">0.00</span>s – <span id="selEnd">0.00</span>s</span>
                <span id="bufferDur" style="opacity:.8"></span>
              </div>
            </div>
          </div>

          <!-- Granular Parameters -->
          <div class="grid-item grid-item-params">
            <div class="param-grid">
              <div class="param-tile" data-tile="pitch">
                <div class="tile-header">PITCH</div>
                <div class="knob" data-knob="pitch" data-tooltip="Pitch shift in semitones (-12 to +12)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="pitch">0</div>
              </div>
              <div class="param-tile" data-tile="density">
                <div class="tile-header">DENSITY</div>
                <div class="knob" data-knob="density" data-tooltip="Grain density - number of grains per second (1-60)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="density">15</div>
              </div>
              <div class="param-tile" data-tile="grain">
                <div class="tile-header">GRAIN</div>
                <div class="knob" data-knob="grain" data-tooltip="Grain size in milliseconds (10-200ms)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="grain">80</div>
              </div>
              <div class="param-tile" data-tile="rand">
                <div class="tile-header">RAND</div>
                <div class="knob" data-knob="rand" data-tooltip="Random start offset in milliseconds (0-200ms)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="rand">40</div>
              </div>
              <div class="param-tile" data-tile="selpos">
                <div class="tile-header">POS</div>
                <div class="knob" data-knob="selpos" data-tooltip="Selection position in buffer (0-100%)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="selpos">0</div>
              </div>
            </div>
          </div>

          <!-- Effects Parameters -->
          <div class="grid-item grid-item-effects">
            <div class="param-grid">
              <div class="param-tile" data-tile="filter">
                <div class="tile-header">FILTER</div>
                <div class="knob" data-knob="filter" data-tooltip="Filter cutoff frequency in Hz (200-12000Hz)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="filter">4000</div>
              </div>
              <div class="param-tile" data-tile="res">
                <div class="tile-header">RES</div>
                <div class="knob" data-knob="res" data-tooltip="Filter resonance/Q factor (0-20)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="res">0</div>
              </div>
              <div class="param-tile" data-tile="dtime">
                <div class="tile-header">DLY-T</div>
                <div class="knob" data-knob="dtime" data-tooltip="Delay time in seconds (0-1.2s)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="dtime">0.25</div>
              </div>
              <div class="param-tile" data-tile="dmix">
                <div class="tile-header">DLY-M</div>
                <div class="knob" data-knob="dmix" data-tooltip="Delay mix amount (0-1)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="dmix">0.15</div>
              </div>
              <div class="param-tile" data-tile="reverb">
                <div class="tile-header">REVERB</div>
                <div class="knob" data-knob="reverb" data-tooltip="Reverb mix amount (0-1)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="reverb">0.2</div>
              </div>
              <div class="param-tile" data-tile="gain">
                <div class="tile-header">GAIN</div>
                <div class="knob" data-knob="gain" data-tooltip="Master gain/output volume (0-1.5)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="gain">0.9</div>
              </div>
            </div>
          </div>

          <!-- Pad Grid -->
          <div class="grid-item grid-item-pads">
            <div id="padGrid" class="pad-grid"></div>
          </div>

          <!-- Motion Canvas -->
          <div class="grid-item grid-item-motion">
            <div class="motion-canvas-wrap">
              <canvas id="motionCanvas" width="300" height="300"></canvas>
              <div id="motionCursor"></div>
            </div>
          </div>

          <!-- XY Pad Speed -->
          <div class="grid-item grid-item-xyspeed">
            <div class="param-grid">
              <div class="param-tile" data-tile="xyspeed">
                <div class="tile-header">RATE</div>
                <div class="knob" data-knob="xyspeed" data-tooltip="XY pad cursor movement rate (0.01-2.0)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="xyspeed">0.15</div>
              </div>
              <div class="param-tile" data-tile="xyshift">
                <div class="tile-header">SHIFT</div>
                <div class="knob" data-knob="xyshift" data-tooltip="XY pad cursor shift amount (0.01-1.0)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="xyshift">0.05</div>
              </div>
            </div>
          </div>

          <!-- Motion Controls -->
          <div class="grid-item grid-item-motion-controls">
            <div class="param-grid">
              <div class="param-tile" data-tile="motion-play">
                <div class="tile-header">PLAY</div>
                <button id="motionPlayBtn" class="knob" title="Play/Pause" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
              <div class="param-tile" data-tile="motion-clear">
                <div class="tile-header">CLEAR</div>
                <button id="motionClearBtn" class="knob" title="Clear Path" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
              <div class="param-tile" data-tile="motion-loop">
                <div class="tile-header">LOOP</div>
                <div class="option-selector" data-selector="motion-loop" data-tooltip="Motion path loop mode: Loop, PingPong, OneShot, Reverse">
                  <button class="option-selector-btn" data-direction="prev" aria-label="Previous option">‹</button>
                  <span class="option-selector-label" data-label="motion-loop">Loop</span>
                  <button class="option-selector-btn" data-direction="next" aria-label="Next option">›</button>
                </div>
                <div class="tile-value" data-val="motion-loop" style="display: none;">Loop</div>
              </div>
              <div class="param-tile" data-tile="motion-speed">
                <div class="tile-header">SPEED</div>
                <div class="knob" data-knob="motion-speed" data-tooltip="Motion path playback speed (0.1-4.0x)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="motion-speed">1.0</div>
              </div>
            </div>
            <!-- Hidden inputs for JavaScript logic -->
            <select id="motionLoopMode" style="display: none;">
              <option value="loop">Loop</option>
              <option value="pingpong">Ping Pong</option>
              <option value="oneshot">One Shot</option>
              <option value="reverse">Reverse</option>
            </select>
            <input id="motionSpeed" type="range" min="0.1" max="4" step="0.1" value="1" style="display: none;" />
          </div>

          <!-- MIDI Learn Controls -->
          <div class="grid-item grid-item-midi">
            <div class="param-grid">
              <div class="param-tile" data-tile="midi-learn">
                <div class="tile-header">MIDI</div>
                <div class="knob toggle-switch-knob" data-knob="midi-learn" data-tooltip="Enable MIDI learn mode - click a control then send MIDI to assign"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="midi-learn">OFF</div>
              </div>
              <div class="param-tile" data-tile="midi-clear">
                <div class="tile-header">CLEAR</div>
                <button id="midiClear" class="knob" title="Remove all MIDI assignments" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
            </div>
          </div>

          <!-- Nudge Controls -->
          <div class="grid-item grid-item-nudge">
            <div class="param-grid">
              <div class="param-tile" data-tile="nudge-left">
                <div class="tile-header">◀</div>
                <button id="nudgeLeft" class="knob" title="Move left" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
              <div class="param-tile" data-tile="nudge-right">
                <div class="tile-header">▶</div>
                <button id="nudgeRight" class="knob" title="Move right" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
              <div class="param-tile" data-tile="nudge-step">
                <div class="tile-header">STEP</div>
                <div class="knob" data-knob="nudge-step" data-tooltip="Nudge step size in milliseconds (1-1000ms)"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="nudge-step">20</div>
              </div>
            </div>
            <!-- Hidden input for JavaScript logic -->
            <input id="nudgeStepMs" type="number" min="1" max="1000" value="20" style="display: none;" />
          </div>

          <!-- Zoom Control -->
          <div class="grid-item grid-item-zoom">
            <div class="zoom-control">
              <div class="zoom-header">ZOOM</div>
              <div class="zoom-value-display" id="zoomValue">1.0x</div>
              <div class="zoom-slider-container">
                <input id="waveZoom" type="range" min="0.1" max="5" step="0.1" value="1" class="zoom-slider" />
              </div>
            </div>
          </div>

          <!-- Recall Per Pad Toggle -->
          <div class="grid-item grid-item-recall">
            <div class="param-grid">
              <div class="param-tile" data-tile="recall">
                <div class="tile-header">RECALL</div>
                <div class="knob toggle-switch-knob active" data-knob="recall" data-tooltip="Recall parameters per pad - ON: smooth transition, OFF: instant"><div class="knob-fill"></div><span class="knob-plus">+</span></div>
                <div class="tile-value" data-val="recall">ON</div>
              </div>
            </div>
          </div>

          <!-- File Controls -->
          <div class="grid-item grid-item-file">
            <div class="param-grid">
              <div class="param-tile param-tile-file-load" data-tile="file-load">
                <div class="tile-header">FILE</div>
                <label for="fileInput" class="knob knob-file-main" data-tooltip="Load audio file (WAV, MP3, etc.) - START HERE" style="cursor: pointer; display: flex; align-items: center; justify-content: center;">
                  <div class="knob-fill" style="height: 0%; display: none;"></div>
                  <span class="knob-plus">⬆</span>
                  <div class="file-loading-spinner" style="display: none;"></div>
                </label>
                <input id="fileInput" type="file" accept="audio/*" class="visually-hidden" />
                <div class="tile-value">0</div>
              </div>
              <div class="param-tile param-tile-clear" data-tile="clear-selection">
                <div class="tile-header">CLEAR</div>
                <button id="clearSelectionBtn" class="knob knob-clear-main" title="Clear selection" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">✕</span></button>
                <div class="tile-value">0</div>
              </div>
            </div>
            <div id="fileName" class="filename" style="font-size: 8px; text-align: center; margin-top: 2px; color: var(--muted);" aria-live="polite"></div>
          </div>

          <!-- Recording Controls -->
          <div class="grid-item grid-item-recording">
            <div class="param-grid">
              <div class="param-tile" data-tile="record-audio">
                <div class="tile-header">REC-A</div>
                <button id="recordBtn" class="knob" title="Start audio recording" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
              <div class="param-tile" data-tile="record-video">
                <div class="tile-header">REC-V</div>
                <button id="recordVideoBtn" class="knob" title="Start video + audio recording" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
              <div class="param-tile" data-tile="stop">
                <div class="tile-header">STOP</div>
                <button id="stopRecordBtn" class="knob" disabled title="Stop recording" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span class="knob-plus">+</span></button>
                <div class="tile-value">0</div>
              </div>
            </div>
            <div id="recordStatus" class="record-status" aria-live="polite">Ready</div>
          </div>

          <!-- Theme Toggle -->
          <div class="grid-item grid-item-theme">
            <div class="param-grid">
              <div class="param-tile" data-tile="theme">
                <div class="tile-header">THEME</div>
                <button id="themeToggle" class="knob" title="Toggle theme (dark/light)" style="cursor: pointer;"><div class="knob-fill" style="height: 0%;"></div><span id="themeIcon" class="knob-plus"></span></button>
                <div class="tile-value">0</div>
              </div>
            </div>
          </div>

          <!-- Value Display Box -->
          <div id="valueDisplayBox" class="grid-item grid-item-value-display">
            <div class="value-display-label">—</div>
            <div class="value-display-value">—</div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Pad Edit Modal -->
    <div id="padEditModal" class="modal" aria-hidden="true" style="display: none;">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <h3>Edit Pad</h3>
        <div class="form-group">
          <label style="display: block; margin-bottom: 8px;">Select Icon</label>
          <div id="padIconGrid" class="icon-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <!-- Icons injected via JS -->
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 16px; display: flex; justify-content: flex-end; gap: 8px;">
          <button id="padEditDelete" class="btn btn-danger" aria-label="Delete this pad" style="margin-right: auto;">Delete Pad</button>
          <button id="padEditCancel" class="btn">Cancel</button>
          <button id="padEditSave" class="btn primary">Save</button>
        </div>
      </div>
    </div>

    <script type="module" src="./src/main.ts"></script>
  </body>
  </html>


