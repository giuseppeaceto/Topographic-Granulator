:root {
  /* Dark theme (default) */
  --bg: #0e0e0f;
  --panel: #171717;
  --text: #e6e6e6;
  --muted: #a9a9a9;
  --accent: #bdbdbd; /* keep neutral for non-pad UI */
  --accent2: #d0d0d0; /* not used for pads; pads get inline colors */
  --warn: #cfcfcf;
  --border: #222735;
  --border-subtle: #2a2a2a;
  --border-strong: #3a3a3a;
  --btn-bg: #202020;
  --btn-bg-hover: #242424;
  --btn-border: #333333;
  --btn-border-hover: #404040;
  --panel-header: #1a1a1a;
  --pad-bg: #121212;
  --pad-active: #242a3b;
  --waveform-wrap: #151515;
  --waveform-bg: #111111;
  --knob-bg: #1e1e1e;
  --knob-indicator: #8a8a8a;
  --tile-header-color: #c8c8c8;
  --xy-wrap: #151515;
  --select-bg: #222222;
  --select-border: #2f2f2f;
  --dropdown-bg: #1a1a1a;
  --dropdown-shadow: rgba(0, 0, 0, 0.5);
  --toolbar-shadow: rgba(0, 0, 0, 0.3);
  --learn-outline: #9a9a9a;
  --hr-color: #2a3042;
  --toggle-slider-bg: #2a2a2a;
  --toggle-slider-thumb: #666;
  --toggle-slider-active: #3a3a3a;
  --knob-dot-color: #d9d9d9;
  --knob-plus-color: #b0b0b0;
  --tile-value-color: #d0d0d0;
}

[data-theme="light"] {
  /* Light theme */
  --bg: #f5f5f7;
  --panel: #ffffff;
  --text: #1d1d1f;
  --muted: #6e6e73;
  --accent: #424245;
  --accent2: #1d1d1f;
  --warn: #333333;
  --border: #d2d2d7;
  --border-subtle: #e5e5ea;
  --border-strong: #c7c7cc;
  --btn-bg: #f5f5f7;
  --btn-bg-hover: #e8e8ed;
  --btn-border: #d2d2d7;
  --btn-border-hover: #c7c7cc;
  --panel-header: #f5f5f7;
  --pad-bg: #ffffff;
  --pad-active: #e8e8ed;
  --waveform-wrap: #fafafa;
  --waveform-bg: #ffffff;
  --knob-bg: #f5f5f7;
  --knob-indicator: #86868d;
  --tile-header-color: #424245;
  --xy-wrap: #fafafa;
  --select-bg: #f5f5f7;
  --select-border: #d2d2d7;
  --dropdown-bg: #ffffff;
  --dropdown-shadow: rgba(0, 0, 0, 0.15);
  --toolbar-shadow: rgba(0, 0, 0, 0.1);
  --learn-outline: #6e6e73;
  --hr-color: #d2d2d7;
  --toggle-slider-bg: #e5e5ea;
  --toggle-slider-thumb: #86868d;
  --toggle-slider-active: #d2d2d7;
  --knob-dot-color: #424245;
  --knob-plus-color: #6e6e73;
  --tile-value-color: #1d1d1f;
}
* { box-sizing: border-box; }
html, body, #app { height: 100%; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  overflow: hidden;
}
.app-header, .app-footer {
  padding: 12px 16px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
}
.app-footer { border-top: 1px solid var(--border); border-bottom: none; }
h1, h2 { margin: 0 0 8px 0; font-weight: 600; }
.app-header-section {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-subtle);
}
.logo-icon {
  width: 80px;
  height: 80px;
  object-fit: contain;
  display: block;
  flex-shrink: 0;
}
.app-header-text {
  display: flex;
  flex-direction: column;
  gap: 4px;
  justify-content: center;
}
.app-logo {
  display: flex;
  align-items: center;
  font-weight: 700;
  letter-spacing: 2px;
  margin: 0;
  font-size: 24px;
  line-height: 1.2;
}
.logo-text {
  font-size: inherit;
  font-weight: inherit;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--text);
}
.app-subtitle {
  margin: 0;
  font-size: 12px;
  color: var(--muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  font-weight: 500;
  padding-left: 0;
  opacity: 0.85;
}
#app { 
  display: flex; 
  flex-direction: column; 
  position: relative;
  height: 100vh;
  overflow: hidden;
}
/* XY Pad Container - Large and centered */
.xy-pad-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  padding-bottom: 80px; /* Space for toolbar */
  overflow: hidden;
  position: relative;
}
.xy-pad-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  max-width: 90vw;
  max-height: calc(100vh - 100px);
}
.xy-pad-wrapper .xy-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  width: 100%;
}
.xy-pad-wrapper .app-header-section {
  margin-bottom: 0;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-subtle);
}
.xy-pad-wrapper .xy-wrap {
  margin: 0;
  padding: 0;
  border: none;
  background: transparent;
  width: 100%;
}
.xy-controls-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 600px;
  gap: 16px;
}
.xy-pad-wrapper .xy-assign {
  width: 100%;
  max-width: 600px;
}
.xy-pad-wrapper #xyPad {
  width: 100%;
  max-width: min(80vh, 80vw);
  height: auto;
  aspect-ratio: 1 / 1;
}
/* Floating Panels */
.floating-panel {
  position: fixed;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 4px 20px var(--dropdown-shadow);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 300px;
  min-height: 200px;
}
.panel-header {
  background: var(--panel-header);
  border-bottom: 1px solid var(--border);
  padding: 10px 12px;
  display: flex;
  align-items: center;
  user-select: none;
}
.panel-header h2 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text);
}
.panel-content {
  flex: 1;
  padding: 5px 5px 3px 5px;
  overflow: hidden; /* No scroll */
  box-sizing: border-box;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
/* Reduce bottom padding for Effects panel */
#panel-effects .panel-content {
  padding-bottom: 2px;
}
/* Ensure all content in panels respects boundaries */
.panel-content > * {
  max-width: 100%;
  box-sizing: border-box;
  flex-shrink: 0;
}
/* Resize Handles */
.resize-handle {
  position: absolute;
  background: transparent;
  z-index: 10;
}
.resize-handle-n {
  top: 0;
  left: 8px;
  right: 8px;
  height: 8px;
  cursor: ns-resize;
}
.resize-handle-s {
  bottom: 0;
  left: 8px;
  right: 8px;
  height: 8px;
  cursor: ns-resize;
}
.resize-handle-e {
  top: 8px;
  bottom: 8px;
  right: 0;
  width: 8px;
  cursor: ew-resize;
}
.resize-handle-w {
  top: 8px;
  bottom: 8px;
  left: 0;
  width: 8px;
  cursor: ew-resize;
}
.resize-handle-ne {
  top: 0;
  right: 0;
  width: 12px;
  height: 12px;
  cursor: nesw-resize;
}
.resize-handle-nw {
  top: 0;
  left: 0;
  width: 12px;
  height: 12px;
  cursor: nwse-resize;
}
.resize-handle-se {
  bottom: 0;
  right: 0;
  width: 12px;
  height: 12px;
  cursor: nwse-resize;
}
.resize-handle-sw {
  bottom: 0;
  left: 0;
  width: 12px;
  height: 12px;
  cursor: nesw-resize;
}
/* Toolbar - Fixed at bottom */
.app-toolbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: var(--panel);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  gap: 16px;
  z-index: 200;
  box-shadow: 0 -2px 10px var(--toolbar-shadow);
}
.toolbar-section {
  display: flex;
  align-items: center;
  gap: 12px;
}
.toolbar-hint {
  flex: 1;
  justify-content: flex-end;
}
.toolbar-hint small {
  color: var(--muted);
  font-size: 11px;
}
.app-main { flex: 1; min-height: 0; display: grid; grid-template-columns: 1.6fr 1fr; gap: 12px; padding: 12px 16px 12px 16px; }
.app-main-3col { grid-template-columns: 1.4fr 1.1fr 0.5fr; }
.file-loader {
  display: flex;
  gap: 8px;
  align-items: center;
}
.recorder-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}
.recorder-controls .btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }
.btn {
  background: var(--btn-bg);
  color: var(--text);
  border: 1px solid var(--btn-border);
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 13px;
}
.btn:hover { background: var(--btn-bg-hover); cursor: pointer; }
.btn-icon {
  background: var(--btn-bg);
  color: var(--muted);
  border: 1px solid var(--btn-border);
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  line-height: 1;
  min-width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.btn-icon:hover {
  background: var(--btn-bg-hover);
  border-color: var(--btn-border-hover);
  color: var(--text);
}
.filename { color: var(--muted); font-size: 12px; }
.midi-toolbar { display:flex; align-items: center; gap: 10px; margin: 6px 0 8px 0; }
.toggle-switch {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
}
.toggle-switch input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: relative;
  width: 44px;
  height: 24px;
  background: var(--toggle-slider-bg);
  border: 1px solid var(--border-strong);
  border-radius: 12px;
  transition: all 0.2s ease;
  flex-shrink: 0;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  left: 2px;
  top: 2px;
  background: var(--toggle-slider-thumb);
  border-radius: 50%;
  transition: all 0.2s ease;
}
.toggle-switch input[type="checkbox"]:checked + .toggle-slider {
  background: var(--toggle-slider-active);
  border-color: var(--btn-border-hover);
}
.toggle-switch input[type="checkbox"]:checked + .toggle-slider::before {
  transform: translateX(20px);
  background: var(--text);
}
.toggle-label {
  color: var(--muted);
  font-size: 13px;
}
.control-label {
  color: var(--muted);
  font-size: 13px;
}
.nudge-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}
.nudge-step {
  color: var(--muted);
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.nudge-input {
  background: var(--btn-bg);
  color: var(--text);
  border: 1px solid var(--btn-border);
  border-radius: 4px;
  padding: 4px 6px;
  width: 50px;
  font-size: 12px;
  text-align: center;
}
.nudge-input:focus {
  outline: none;
  border-color: var(--btn-border-hover);
}
.pads, .controls {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  min-height: 0;
  display: flex;
  flex-direction: column;
}
/* Update floating panel content styles */
.floating-panel .waveform-wrap {
  margin: 0;
  flex-shrink: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
}
.floating-panel .pad-grid {
  margin: 0;
  flex-shrink: 0;
}
/* Floating panel specific param-grid layouts - optimized for no scroll */
.floating-panel .param-grid {
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin: 0;
  flex-shrink: 0;
}
/* Parameters panel: 5 items, use 3 columns (2-2-1) */
#panel-parameters .param-grid {
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
}
/* Effects panel: 6 items + 2 for speed, use 3 columns */
#panel-effects .param-grid {
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
}
/* Compact param tiles for floating panels */
.floating-panel .param-tile {
  padding: 4px;
  min-width: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  min-height: 70px;
}
.floating-panel .knob {
  width: 40px;
  height: 40px;
  --knob-radius: 12px;
  flex-shrink: 0;
}
.floating-panel .knob::before {
  width: 4px;
  height: 4px;
}
.floating-panel .knob-dot {
  width: 6px;
  height: 6px;
}
.floating-panel .knob-plus {
  font-size: 10px;
}
.floating-panel .tile-header {
  font-size: 9px;
  margin: 0 0 1px 0;
  line-height: 1.1;
  text-align: center;
}
.floating-panel .tile-value {
  font-size: 10px;
  margin: 1px 0 0 0;
  line-height: 1.1;
}
/* Compact headings in floating panels */
.panel-content h2 {
  font-size: 11px;
  margin: 2px 0 2px 0;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  flex-shrink: 0;
}
/* Compact control groups in floating panels */
.floating-panel .control-group {
  margin: 0;
  flex-wrap: nowrap;
  gap: 4px;
  flex-shrink: 0;
}
.floating-panel .control-group label {
  width: 100%;
  grid-template-columns: 1fr;
  gap: 4px;
  margin: 0;
}
.floating-panel .toggle-label {
  font-size: 10px;
  line-height: 1.2;
}
.floating-panel .midi-toolbar {
  margin: 0;
  flex-wrap: nowrap;
  gap: 6px;
  flex-shrink: 0;
}
.floating-panel .toggle-switch {
  flex-shrink: 0;
}
.floating-panel .toggle-slider {
  width: 36px;
  height: 20px;
}
.floating-panel .toggle-slider::before {
  width: 14px;
  height: 14px;
}
.floating-panel .toggle-switch input[type="checkbox"]:checked + .toggle-slider::before {
  transform: translateX(16px);
}
/* Compact nudge controls in floating panels */
.floating-panel .nudge-controls {
  flex-wrap: nowrap;
  gap: 4px;
  flex-shrink: 0;
}
.floating-panel .nudge-step {
  font-size: 10px;
  gap: 2px;
}
.floating-panel .nudge-input {
  width: 40px;
  padding: 2px 4px;
  font-size: 10px;
}
.floating-panel .btn-icon {
  padding: 4px 8px;
  min-width: 28px;
  height: 28px;
  font-size: 12px;
}
.waveform-wrap {
  margin-bottom: 12px;
  background: var(--waveform-wrap);
  border: 1px solid var(--border-subtle);
  border-radius: 8px;
  padding: 8px;
}
#waveform {
  width: 100%;
  height: 160px;
  display: block;
  background: var(--waveform-bg);
  border-radius: 6px;
}
.waveform-meta {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 12px;
  color: var(--muted);
}
.pad-grid {
  margin-top: 8px;
  display: grid;
  grid-template-columns: repeat(8, minmax(48px, 1fr)); /* always 8 pads on one row */
  gap: 8px;
  overflow: hidden;
  padding-bottom: 6px;
}
.controls { overflow: auto; }
.controls h2 { position: sticky; top: 0; background: linear-gradient(180deg, var(--panel) 70%, rgba(0,0,0,0)); padding-bottom: 6px; z-index: 1; }
.pad-grid {
  margin-top: 8px;
  display: grid;
  gap: 10px;
}
.pad {
  aspect-ratio: 1 / 1;               /* square like knobs */
  width: 100%;                       /* fill its grid cell */
  background: var(--pad-bg);
  border: 1px solid var(--border-strong);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--muted);
  user-select: none;
  transition: transform 0.04s ease, background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}
.pad.assigned { color: inherit; border-color: var(--border-strong); }
.pad.active { outline: none; }
.pad:active { transform: translateY(2px); background: var(--pad-active); }
.learn-pending { outline: 1px dashed var(--learn-outline); outline-offset: 2px; }
.control-group {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  margin: 10px 0;
}
label { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; width: 100%; }
input[type="range"] { width: 100%; }
hr { border: none; border-top: 1px solid var(--hr-color); margin: 14px 0; }

.xy-wrap {
  margin: 10px 0 16px 0;
  padding: 10px;
  border: 1px solid var(--border-subtle);
  border-radius: 8px;
  background: var(--waveform-wrap);
}
.xy-header {
  display: flex; align-items: center; justify-content: flex-end;
  margin-bottom: 8px;
}
.xy-hint { font-size: 12px; color: var(--muted); }
#xyPad {
  display: block; width: 100%; height: auto; aspect-ratio: 1 / 1;
  background: var(--waveform-bg); border: 1px solid var(--border-subtle); border-radius: 6px;
  margin-bottom: 8px;
}
.xy-assign { display: flex; flex-direction: column; gap: 8px; }
.xy-assign-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.xy-assign label { display: grid; gap: 6px; font-size: 12px; color: var(--muted); }
.xy-assign select {
  background: var(--select-bg); color: var(--text); border: 1px solid var(--select-border); border-radius: 6px; padding: 6px;
}
/* Custom Select Styles */
.custom-select {
  position: relative;
  width: 100%;
}
.custom-select-button {
  width: 100%;
  background: var(--btn-bg);
  color: var(--text);
  border: 1px solid var(--btn-border);
  border-radius: 6px;
  padding: 8px 10px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
  text-align: left;
}
.custom-select-button:hover {
  background: var(--btn-bg-hover);
  border-color: var(--btn-border-hover);
}
.custom-select-button.active {
  background: var(--btn-bg-hover);
  border-color: var(--btn-border-hover);
}
.custom-select-icon {
  font-size: 14px;
  line-height: 1;
  flex-shrink: 0;
  width: 16px;
  text-align: center;
  color: var(--accent);
}
.custom-select-label {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.custom-select-arrow {
  font-size: 10px;
  color: var(--muted);
  flex-shrink: 0;
  transition: transform 0.2s ease;
}
.custom-select-button.active .custom-select-arrow {
  transform: rotate(180deg);
}
.custom-select-dropdown {
  position: fixed;
  background: var(--dropdown-bg);
  border: 1px solid var(--btn-border);
  border-radius: 6px;
  box-shadow: 0 4px 12px var(--dropdown-shadow);
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
  overflow-x: hidden;
  display: none;
  margin-top: 2px;
}
.custom-select-dropdown.open-up {
  margin-top: 0;
  margin-bottom: 2px;
  box-shadow: 0 -4px 12px var(--dropdown-shadow);
}
.custom-select-option {
  padding: 8px 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--text);
  transition: background 0.15s ease;
}
.custom-select-option:hover {
  background: var(--btn-bg-hover);
}
.custom-select-option.selected {
  background: var(--btn-bg-hover);
  color: var(--accent);
}
.custom-select-option:focus {
  outline: none;
  background: var(--btn-bg-hover);
}
.custom-select-option .custom-select-icon {
  color: var(--accent);
}
.custom-select-option.selected .custom-select-icon {
  color: var(--accent2);
}
.xy-mode-btn {
  background: var(--btn-bg);
  color: var(--muted);
  border: 1px solid var(--btn-border);
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 36px;
}
.xy-mode-btn:hover {
  background: var(--btn-bg-hover);
  border-color: var(--btn-border-hover);
}
.xy-mode-btn.active {
  background: var(--btn-bg-hover);
  border-color: var(--btn-border-hover);
  color: var(--text);
}
.xy-mode-icon {
  font-size: 18px;
  line-height: 1;
  display: block;
}

.param-grid {
  margin-top: 8px;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}
.controls-right .param-grid { grid-template-columns: repeat(2, 1fr); }
.param-tile {
  border: 1px solid var(--border-strong);
  background: var(--pad-bg);
  border-radius: 6px;
  padding: 10px 10px 8px 10px;
  display: grid;
  grid-template-rows: auto 1fr auto;
  align-items: center;
}
.tile-header {
  font-size: 12px;
  letter-spacing: 1px;
  color: var(--tile-header-color);
  margin-bottom: 8px;
}
.knob {
  position: relative;
  margin: 0 auto;
  width: 52px; height: 52px;
  border-radius: 50%;
  background: var(--knob-bg);
  border: 1px solid var(--border-strong);
  display: flex; align-items: center; justify-content: center;
  user-select: none;
  --knob-radius: 16px; /* distance from center for markers */
}
.knob::before {
  /* static indicator for position 0 (fully closed) */
  content: '';
  position: absolute;
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--knob-indicator);
  left: 50%; top: 50%;
  transform: translate(-50%, -50%) rotate(-135deg) translateX(var(--knob-radius));
}
.knob-dot {
  position: absolute;
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--knob-dot-color);
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  will-change: transform;
}
.knob-plus {
  color: var(--knob-plus-color);
  font-weight: 700;
  opacity: .6;
}
.tile-value {
  text-align: center;
  margin-top: 8px;
  font-size: 14px;
  color: var(--tile-value-color);
}

@media (max-width: 1100px) {
  .param-grid { grid-template-columns: repeat(2, 1fr); }
  .xy-pad-wrapper #xyPad {
    max-width: min(70vh, 90vw);
  }
  .floating-panel {
    min-width: 250px;
    min-height: 150px;
  }
  .floating-panel .param-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
  }
  .floating-panel .knob {
    width: 44px;
    height: 44px;
  }
}

